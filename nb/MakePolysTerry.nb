(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 10.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     68313,       1960]
NotebookOptionsPosition[     62178,       1767]
NotebookOutlinePosition[     62549,       1783]
CellTagsIndexPosition[     62506,       1780]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Finding the Score", "Title",
 CellChangeTimes->{{3.6634884976046095`*^9, 3.66348850637381*^9}}],

Cell["Load the data for the t=0.1 double pendulum", "Text",
 CellChangeTimes->{{3.663487411825269*^9, 3.663487434541382*^9}, {
  3.6634884361279097`*^9, 3.6634884483455915`*^9}, {3.6634884794316697`*^9, 
  3.6634884831403055`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"GetData", "[", "sz_", "]"}], ":=", 
   RowBox[{"Transpose", "[", " ", 
    RowBox[{"Partition", "[", " ", 
     RowBox[{
      RowBox[{"ReadList", "[", " ", 
       RowBox[{"sz", ",", " ", "Number", ",", " ", 
        RowBox[{"RecordSeparators", "\[Rule]", 
         RowBox[{"{", "\"\<,\>\"", "}"}]}]}], "]"}], ",", " ", "2"}], "]"}], 
    "]"}]}], ";"}]], "Input"],

Cell[BoxData[
 RowBox[{
  RowBox[{"data", " ", "=", " ", 
   RowBox[{
   "GetData", "[", "\"\<c:/Users/User/Desktop/mma_double.csv\>\"", "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6629857011865416`*^9, 3.662985702975813*^9}, {
  3.662985743564044*^9, 3.662985748233361*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dt", ":=", "0.1"}], ";"}]], "Input",
 CellChangeTimes->{{3.6629857597145147`*^9, 3.662985765011273*^9}, 
   3.663487445682295*^9}],

Cell["Construct times", "Text",
 CellChangeTimes->{{3.6634874595041113`*^9, 3.66348746249924*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"times", " ", "=", "  ", 
   RowBox[{
    RowBox[{"Range", "[", 
     RowBox[{"0", ",", " ", 
      RowBox[{"(", 
       RowBox[{
        RowBox[{"Length", "[", 
         RowBox[{"data", "[", 
          RowBox[{"[", "1", "]"}], "]"}], "]"}], "-", "1"}], ")"}]}], "]"}], 
    "*", "dt"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.6629857809435906`*^9, 3.6629857856209407`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"th1", " ", "=", " ", 
   RowBox[{"Transpose", "[", 
    RowBox[{"{", 
     RowBox[{"times", ",", " ", 
      RowBox[{
       RowBox[{"data", "[", 
        RowBox[{"[", "1", "]"}], "]"}], "+", "1*^-15"}]}], "}"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.662985815706128*^9, 3.662985837681739*^9}, {
  3.663507338226534*^9, 3.6635073430499687`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"th2", " ", "=", " ", 
   RowBox[{"Transpose", "[", 
    RowBox[{"{", 
     RowBox[{"times", ",", " ", 
      RowBox[{
       RowBox[{"data", "[", 
        RowBox[{"[", "2", "]"}], "]"}], "+", "1*^-15"}]}], "}"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6629858396101093`*^9, 3.662985852825468*^9}, {
  3.6635073469507327`*^9, 3.663507351425928*^9}}],

Cell["\<\
Differentiate using interpolation polynomials - this could be bad if the \
curves have a significant curvature\
\>", "Text",
 CellChangeTimes->{{3.6634874943828897`*^9, 3.6634875291626253`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"w1", " ", "=", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{"Interpolation", "[", "th1", "]"}], ")"}], "'"}], "[", "times", 
    "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.6629859611376505`*^9, 3.6629859928471766`*^9}, 
   3.663487535108822*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"w2", " ", "=", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{"Interpolation", "[", "th2", "]"}], ")"}], "'"}], "[", "times", 
    "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.6629859972282667`*^9, 3.662986021632603*^9}, 
   3.6634875377396917`*^9}],

Cell["\<\
We now have th1, th2 and estimates for w1 and w2; presumably we should only \
do this once for each data set
Below is a function L which generates functions. That is it will create a \
function which is out polynomial. This function has a list a which are the \
coefficients
as well as the values of th1, th2, w1, w2. The function L (the polynomial \
generator has input a list which are the powers of the monomial terms eg \
{1,1,1,1, 2,2,2,2}
This would be a[1]th1th2w1w2 + a[2]th1^2th2^2w1^2w2^2\
\>", "Text",
 CellChangeTimes->{{3.6634875827696943`*^9, 3.6634877911907578`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"L", "[", "var_", "]"}], ":=", 
  RowBox[{"Function", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "a", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", "w2"}], 
     "}"}], ",", " ", 
    RowBox[{"Apply", "[", " ", 
     RowBox[{"Plus", ",", " ", 
      RowBox[{"a", "*", 
       RowBox[{"Map", "[", " ", 
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{"vv", ",", " ", 
           RowBox[{
            RowBox[{"th1", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], " ", 
            RowBox[{"th2", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], " ", 
            RowBox[{"w1", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "3", "]"}], "]"}]}], " ", 
            RowBox[{"w2", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "4", "]"}], "]"}]}]}]}], " ", "]"}], ",", "  ", 
         "var"}], " ", "]"}]}]}], " ", "]"}]}], " ", "]"}]}]], "Input"],

Cell["\<\
This shows how th function can be used to create an example polynomial\
\>", "Text",
 CellChangeTimes->{{3.662986193170456*^9, 3.6629862227234497`*^9}, {
  3.66348780433809*^9, 3.6634878278037643`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"egg", " ", "=", " ", 
   RowBox[{"L", "[", 
    RowBox[{"{", " ", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", " ", 
      RowBox[{"{", 
       RowBox[{"2", ",", "2", ",", "2", ",", "2"}], "}"}]}], "}"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.662986243755398*^9, 3.662986262218508*^9}, 
   3.663487840306641*^9}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"egg", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"1.5", ",", "2.5"}], "}"}], ",", " ", "1", ",", "2", ",", "3", 
   ",", "4"}], "]"}]], "Input",
 CellChangeTimes->{{3.6629862686791253`*^9, 3.662986292649124*^9}}],

Cell[BoxData["1476.`"], "Output",
 CellChangeTimes->{3.662986292930354*^9, 3.6634878461337814`*^9}]
}, Open  ]],

Cell["\<\
In reality to find the score we never actually need to know the value of the \
polynomial. What we need are the partial derivatives dL/dq and dL/dw and the \
total time derivative of the second. Since these are polynomial we can easily \
differentiate then in the same manner as L above.\
\>", "Text",
 CellChangeTimes->{{3.6634878659428563`*^9, 3.663487967864258*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dLdth1", "[", "var_", "]"}], ":=", 
  RowBox[{"Function", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "a", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", "w2"}], 
     "}"}], ",", " ", 
    RowBox[{"Apply", "[", " ", 
     RowBox[{"Plus", ",", " ", 
      RowBox[{"a", "*", 
       RowBox[{"Map", "[", " ", 
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{"vv", ",", " ", 
           RowBox[{
            RowBox[{"vv", "[", 
             RowBox[{"[", "1", "]"}], "]"}], " ", 
            RowBox[{"th1", "^", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"vv", "[", 
                RowBox[{"[", "1", "]"}], "]"}], "-", "1"}], ")"}]}], " ", 
            RowBox[{"th2", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], " ", 
            RowBox[{"w1", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "3", "]"}], "]"}]}], " ", 
            RowBox[{"w2", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "4", "]"}], "]"}]}]}]}], " ", "]"}], ",", "  ", 
         "var"}], " ", "]"}]}]}], " ", "]"}]}], " ", "]"}]}]], "Input",
 CellChangeTimes->{{3.6629863917785735`*^9, 3.6629864428017917`*^9}, {
  3.662986485406086*^9, 3.662986488956608*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dLdth2", "[", "var_", "]"}], ":=", 
  RowBox[{"Function", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "a", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", "w2"}], 
     "}"}], ",", " ", 
    RowBox[{"Apply", "[", " ", 
     RowBox[{"Plus", ",", " ", 
      RowBox[{"a", "*", 
       RowBox[{"Map", "[", " ", 
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{"vv", ",", " ", 
           RowBox[{
            RowBox[{"th1", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], " ", 
            RowBox[{"vv", "[", 
             RowBox[{"[", "2", "]"}], "]"}], 
            RowBox[{"th2", "^", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"vv", "[", 
                RowBox[{"[", "2", "]"}], "]"}], "-", "1"}], ")"}]}], " ", 
            RowBox[{"w1", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "3", "]"}], "]"}]}], " ", 
            RowBox[{"w2", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "4", "]"}], "]"}]}]}]}], " ", "]"}], ",", "  ", 
         "var"}], " ", "]"}]}]}], " ", "]"}]}], " ", "]"}]}]], "Input",
 CellChangeTimes->{{3.6629865060837526`*^9, 3.6629865465655336`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dLdw1", "[", "var_", "]"}], ":=", 
  RowBox[{"Function", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "a", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", "w2"}], 
     "}"}], ",", " ", 
    RowBox[{"Apply", "[", " ", 
     RowBox[{"Plus", ",", " ", 
      RowBox[{"a", "*", 
       RowBox[{"Map", "[", " ", 
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{"vv", ",", " ", 
           RowBox[{
            RowBox[{"th1", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], " ", 
            RowBox[{"th2", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], " ", 
            RowBox[{"vv", "[", 
             RowBox[{"[", "3", "]"}], "]"}], 
            RowBox[{"w1", "^", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"vv", "[", 
                RowBox[{"[", "3", "]"}], "]"}], "-", "1"}], ")"}]}], " ", 
            RowBox[{"w2", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "4", "]"}], "]"}]}]}]}], " ", "]"}], ",", "  ", 
         "var"}], " ", "]"}]}]}], " ", "]"}]}], " ", "]"}]}]], "Input",
 CellChangeTimes->{{3.6629865604604044`*^9, 3.662986579254755*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dLdw2", "[", "var_", "]"}], ":=", 
  RowBox[{"Function", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "a", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", "w2"}], 
     "}"}], ",", " ", 
    RowBox[{"Apply", "[", " ", 
     RowBox[{"Plus", ",", " ", 
      RowBox[{"a", "*", 
       RowBox[{"Map", "[", " ", 
        RowBox[{
         RowBox[{"Function", "[", 
          RowBox[{"vv", ",", " ", 
           RowBox[{
            RowBox[{"th1", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "1", "]"}], "]"}]}], " ", 
            RowBox[{"th2", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "2", "]"}], "]"}]}], " ", 
            RowBox[{"w1", "^", 
             RowBox[{"vv", "[", 
              RowBox[{"[", "3", "]"}], "]"}]}], " ", 
            RowBox[{"vv", "[", 
             RowBox[{"[", "4", "]"}], "]"}], 
            RowBox[{"w2", "^", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"vv", "[", 
                RowBox[{"[", "4", "]"}], "]"}], "-", "1"}], ")"}]}]}]}], " ", 
          "]"}], ",", "  ", "var"}], " ", "]"}]}]}], " ", "]"}]}], " ", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.6629865862146997`*^9, 3.6629866059026566`*^9}}],

Cell["This is an example ", "Text",
 CellChangeTimes->{{3.6634879897608113`*^9, 3.6634879994486947`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"myPoly", " ", "=", " ", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", " ", 
    RowBox[{"{", 
     RowBox[{"2", ",", "2", ",", "2", ",", "2"}], "}"}]}], "}"}]}]], "Input",
 CellChangeTimes->{{3.6629866603313513`*^9, 3.6629866810670815`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
   RowBox[{"{", 
    RowBox[{"2", ",", "2", ",", "2", ",", "2"}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{3.6629866819066486`*^9, 3.6634880047314467`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"ddth1", " ", "=", 
  RowBox[{"dLdth1", "[", "myPoly", "]"}]}]], "Input",
 CellChangeTimes->{{3.662986691449436*^9, 3.6629867275230837`*^9}}],

Cell[BoxData[
 RowBox[{"Function", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"a$", ",", "th1$", ",", "th2$", ",", "w1$", ",", "w2$"}], "}"}], 
   ",", 
   RowBox[{"Plus", "@@", 
    RowBox[{"(", 
     RowBox[{"a$", " ", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{"vv$", ",", 
         RowBox[{
          RowBox[{
          "vv$", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], " ", 
          SuperscriptBox["th1$", 
           RowBox[{
            RowBox[{
            "vv$", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
            "-", "1"}]], " ", 
          SuperscriptBox["th2$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]], 
          " ", 
          SuperscriptBox["w1$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}]], 
          " ", 
          SuperscriptBox["w2$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}]]}]}],
         "]"}], "/@", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"2", ",", "2", ",", "2", ",", "2"}], "}"}]}], "}"}]}]}], 
     ")"}]}]}], "]"}]], "Output",
 CellChangeTimes->{{3.6629867181634054`*^9, 3.6629867282105455`*^9}, 
   3.663488007862688*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"ddth2", " ", "=", " ", 
  RowBox[{"dLdth2", "[", "myPoly", "]"}]}]], "Input",
 CellChangeTimes->{{3.662986732558633*^9, 3.6629867477614393`*^9}}],

Cell[BoxData[
 RowBox[{"Function", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"a$", ",", "th1$", ",", "th2$", ",", "w1$", ",", "w2$"}], "}"}], 
   ",", 
   RowBox[{"Plus", "@@", 
    RowBox[{"(", 
     RowBox[{"a$", " ", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{"vv$", ",", 
         RowBox[{
          SuperscriptBox["th1$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]], 
          " ", 
          RowBox[{
          "vv$", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], " ", 
          SuperscriptBox["th2$", 
           RowBox[{
            RowBox[{
            "vv$", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
            "-", "1"}]], " ", 
          SuperscriptBox["w1$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}]], 
          " ", 
          SuperscriptBox["w2$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}]]}]}],
         "]"}], "/@", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"2", ",", "2", ",", "2", ",", "2"}], "}"}]}], "}"}]}]}], 
     ")"}]}]}], "]"}]], "Output",
 CellChangeTimes->{3.66298674859102*^9, 3.6634880101973457`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"ddw1", " ", "=", " ", 
  RowBox[{"dLdw1", "[", "myPoly", "]"}]}]], "Input",
 CellChangeTimes->{{3.6629867507035294`*^9, 3.66298676649374*^9}}],

Cell[BoxData[
 RowBox[{"Function", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"a$", ",", "th1$", ",", "th2$", ",", "w1$", ",", "w2$"}], "}"}], 
   ",", 
   RowBox[{"Plus", "@@", 
    RowBox[{"(", 
     RowBox[{"a$", " ", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{"vv$", ",", 
         RowBox[{
          SuperscriptBox["th1$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]], 
          " ", 
          SuperscriptBox["th2$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]], 
          " ", 
          RowBox[{
          "vv$", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], " ", 
          SuperscriptBox["w1$", 
           RowBox[{
            RowBox[{
            "vv$", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], 
            "-", "1"}]], " ", 
          SuperscriptBox["w2$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}]]}]}],
         "]"}], "/@", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"2", ",", "2", ",", "2", ",", "2"}], "}"}]}], "}"}]}]}], 
     ")"}]}]}], "]"}]], "Output",
 CellChangeTimes->{3.662986766891038*^9, 3.6634880121287174`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"ddw2", " ", "=", " ", 
  RowBox[{"dLdw2", "[", "myPoly", "]"}]}]], "Input",
 CellChangeTimes->{{3.6629867683380575`*^9, 3.6629867784772816`*^9}, {
  3.6634880143983307`*^9, 3.663488018113961*^9}}],

Cell[BoxData[
 RowBox[{"Function", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"a$", ",", "th1$", ",", "th2$", ",", "w1$", ",", "w2$"}], "}"}], 
   ",", 
   RowBox[{"Plus", "@@", 
    RowBox[{"(", 
     RowBox[{"a$", " ", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{"vv$", ",", 
         RowBox[{
          SuperscriptBox["th1$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]], 
          " ", 
          SuperscriptBox["th2$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]], 
          " ", 
          SuperscriptBox["w1$", 
           RowBox[{
           "vv$", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}]], 
          " ", 
          RowBox[{
          "vv$", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}], " ", 
          SuperscriptBox["w2$", 
           RowBox[{
            RowBox[{
            "vv$", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}], 
            "-", "1"}]]}]}], "]"}], "/@", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
         RowBox[{"{", 
          RowBox[{"2", ",", "2", ",", "2", ",", "2"}], "}"}]}], "}"}]}]}], 
     ")"}]}]}], "]"}]], "Output",
 CellChangeTimes->{3.662986778853522*^9, 3.663488019059642*^9}]
}, Open  ]],

Cell["Now choose 2 coefficients", "Text",
 CellChangeTimes->{{3.6634880312753115`*^9, 3.663488040101604*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"a", " ", "=", " ", 
  RowBox[{"{", 
   RowBox[{"2", ",", "1"}], "}"}]}]], "Input",
 CellChangeTimes->{{3.662986838880191*^9, 3.6629869077650976`*^9}, {
  3.6629871478705196`*^9, 3.6629871907989864`*^9}, {3.6629885838519526`*^9, 
  3.66298858417421*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"2", ",", "1"}], "}"}]], "Output",
 CellChangeTimes->{{3.662987173470682*^9, 3.6629871913003583`*^9}, 
   3.662988585165888*^9, 3.6634880427214355`*^9}]
}, Open  ]],

Cell["\<\
Remember that th2 has a {time, th2} structure so we really want to select the \
nested list\
\>", "Text",
 CellChangeTimes->{{3.6629879223550367`*^9, 3.66298798042231*^9}, {
  3.6634880633240714`*^9, 3.6634881129393454`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dth1", " ", "=", " ", 
   RowBox[{"ddth1", "[", 
    RowBox[{"a", ",", " ", 
     RowBox[{
      RowBox[{"Transpose", "[", "th1", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}], ",", " ", 
     RowBox[{
      RowBox[{"Transpose", "[", "th2", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}], ",", " ", "w1", ",", "w2"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6629871977679377`*^9, 3.6629872138733783`*^9}, 
   3.6629872542260447`*^9, {3.6629877276607213`*^9, 3.66298774680733*^9}, {
   3.662987831140232*^9, 3.6629878792724247`*^9}, {3.662987990327347*^9, 
   3.6629880033536015`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dth2", " ", "=", " ", 
   RowBox[{"ddth2", "[", 
    RowBox[{"a", ",", " ", 
     RowBox[{
      RowBox[{"Transpose", "[", "th1", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}], ",", " ", 
     RowBox[{
      RowBox[{"Transpose", "[", "th2", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}], ",", " ", "w1", ",", "w2"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6629872570280647`*^9, 3.662987284690694*^9}, {
  3.6629880077627316`*^9, 3.662988009909234*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dw1", " ", "=", " ", 
   RowBox[{"ddw1", "[", 
    RowBox[{"a", ",", " ", 
     RowBox[{
      RowBox[{"Transpose", "[", "th1", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}], ",", " ", 
     RowBox[{
      RowBox[{"Transpose", "[", "th2", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}], ",", " ", "w1", ",", "w2"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6629872741162043`*^9, 3.662987296467059*^9}, {
  3.6629880157464037`*^9, 3.6629880170303164`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dw2", " ", "=", " ", 
   RowBox[{"ddw2", "[", 
    RowBox[{"a", ",", " ", 
     RowBox[{
      RowBox[{"Transpose", "[", "th1", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}], ",", " ", 
     RowBox[{
      RowBox[{"Transpose", "[", "th2", "]"}], "[", 
      RowBox[{"[", "2", "]"}], "]"}], ",", " ", "w1", ",", "w2"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.662987298094215*^9, 3.662987309593377*^9}, {
   3.6629880224991727`*^9, 3.662988023748088*^9}, 3.6634881222219124`*^9}],

Cell["\<\
So dth1, dth2, dw1 and dw2 are the functions for partial derivatives with the \
ploynomial structure specified by myPoly and the coefficients specified by a\
\>", "Text",
 CellChangeTimes->{{3.663488131868765*^9, 3.663488179593669*^9}}],

Cell["\<\
Again use interpolating functions to find the total time derivative\
\>", "Text",
 CellChangeTimes->{{3.663488217182371*^9, 3.663488230268668*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dw1dt", " ", "=", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{"Interpolation", "[", " ", 
       RowBox[{"Transpose", "[", " ", 
        RowBox[{"{", 
         RowBox[{"times", ",", " ", "dw1"}], "}"}], "]"}], "]"}], ")"}], 
     "'"}], "[", "times", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.662987429177357*^9, 3.6629874732026324`*^9}, 
   3.6629882077878065`*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"dw2dt", " ", "=", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"(", 
      RowBox[{"Interpolation", "[", " ", 
       RowBox[{"Transpose", "[", " ", 
        RowBox[{"{", 
         RowBox[{"times", ",", " ", "dw2"}], "}"}], "]"}], "]"}], ")"}], 
     "'"}], "[", "times", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.662987483346817*^9, 3.662987504347758*^9}, 
   3.662988210160486*^9}],

Cell["\<\
Now we can find the variational derivative at each point - this should be \
close to 0\
\>", "Text",
 CellChangeTimes->{{3.6634882470906177`*^9, 3.663488268233638*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"EL", " ", "=", " ", 
   RowBox[{"dth1", " ", "+", " ", "dth2", " ", "-", " ", 
    RowBox[{"(", 
     RowBox[{"dw1dt", " ", "+", " ", "dw2dt"}], ")"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.6629875123894496`*^9, 3.6629875623135767`*^9}, {
  3.662987593260539*^9, 3.6629875962426796`*^9}}],

Cell["Now square and add them to find EL[data]", "Text",
 CellChangeTimes->{{3.663488296053401*^9, 3.663488314097226*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"ELData", "=", " ", 
  RowBox[{"Apply", "[", " ", 
   RowBox[{"Plus", ",", " ", 
    RowBox[{"EL", "^", "2"}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.6629882402728767`*^9, 3.662988276633735*^9}, {
  3.662988411853795*^9, 3.662988448871092*^9}, {3.662988490751815*^9, 
  3.6629885026532984`*^9}, {3.6634883220318623`*^9, 3.6634883300145254`*^9}}],

Cell[BoxData["10003.975239432573`"], "Output",
 CellChangeTimes->{{3.6629884411866055`*^9, 3.6629884492673607`*^9}, {
   3.6629884923119245`*^9, 3.662988503912165*^9}, 3.662988610427841*^9, 
   3.6634883360748415`*^9}]
}, Open  ]],

Cell["Now square and add to find the normalisation score", "Text",
 CellChangeTimes->{{3.663488394823597*^9, 3.663488402669145*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"NData", " ", "=", " ", 
  RowBox[{"Apply", "[", 
   RowBox[{"Plus", ",", " ", 
    RowBox[{
     RowBox[{"dth1", "^", "2"}], " ", "+", " ", 
     RowBox[{"dth2", "^", "2"}], " ", "+", " ", 
     RowBox[{"dw1dt", "^", "2"}], " ", "+", " ", 
     RowBox[{"dw2dt", "^", "2"}]}]}], "]"}]}]], "Input",
 CellChangeTimes->{{3.6629882971583166`*^9, 3.662988338393581*^9}, {
  3.662988417435732*^9, 3.662988418436449*^9}, {3.6629884517541113`*^9, 
  3.662988452594715*^9}, {3.662988506984346*^9, 3.6629885072725515`*^9}, {
  3.6634883453083906`*^9, 3.6634883459918756`*^9}}],

Cell[BoxData["29322.61681358052`"], "Output",
 CellChangeTimes->{3.662988453145101*^9, 3.662988507939023*^9, 
  3.662988613486003*^9, 3.663488347467923*^9, 3.663488405938463*^9}]
}, Open  ]],

Cell["Repeat the process with the control path", "Text",
 CellChangeTimes->{{3.6634884205628576`*^9, 3.6634884282633495`*^9}}],

Cell["Choose a path of constant velocity", "Text",
 CellChangeTimes->{{3.663498129217667*^9, 3.663498153807155*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"genvel", " ", "=", " ", "0.1"}], ";"}]], "Input",
 CellChangeTimes->{{3.6634976596300673`*^9, 3.663497669206899*^9}}],

Cell["Add 1e-15 to th1 and th2 so that there are no 0^0 errors", "Text",
 CellChangeTimes->{{3.6635072977948294`*^9, 3.663507320764159*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"controlth1", " ", "=", " ", 
   RowBox[{"controlth2", " ", "=", " ", 
    RowBox[{"Transpose", "[", 
     RowBox[{"{", 
      RowBox[{"times", ",", " ", 
       RowBox[{
        RowBox[{"genvel", "*", "times"}], " ", "+", " ", "1*^-15"}]}], "}"}], 
     "]"}]}]}], ";"}]], "Input",
 CellChangeTimes->{{3.6634976815056067`*^9, 3.663497692864679*^9}, {
  3.6634980920372453`*^9, 3.6634980963383055`*^9}, {3.663506653438586*^9, 
  3.6635066595709143`*^9}, {3.6635068048611298`*^9, 3.6635068099637537`*^9}, {
  3.6635072369205756`*^9, 3.6635072455106993`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"controlw1", " ", "=", " ", 
    RowBox[{"controlw2", "=", 
     RowBox[{"Table", "[", 
      RowBox[{"genvel", ",", 
       RowBox[{"{", 
        RowBox[{"Length", "[", "times", "]"}], "}"}]}], "]"}]}]}], ";"}], 
  "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.6634976944498024`*^9, 3.6634977047581244`*^9}, {
   3.663497843730866*^9, 3.6634978809863153`*^9}, {3.663497911154761*^9, 
   3.663497920545422*^9}, {3.663497951620493*^9, 3.6634979629915724`*^9}, {
   3.663498022238662*^9, 3.6634981117152524`*^9}, 3.6634981660798435`*^9, {
   3.663506715955985*^9, 3.663506719256316*^9}, {3.66350677806409*^9, 
   3.6635068510239277`*^9}}],

Cell["\<\
Build a function which creates functions for the partial derivatives wrt th1, \
th2, w1, w2\
\>", "Text",
 CellChangeTimes->{{3.6634982067817593`*^9, 3.663498222694063*^9}, {
  3.663498948210167*^9, 3.663498964004386*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MakePartialDerivativesFns", "[", "var1_", "]"}], ":=", " ", 
    RowBox[{"{", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "a1", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", 
          "w2"}], "}"}], ",", " ", 
        RowBox[{"Apply", "[", " ", 
         RowBox[{"Plus", ",", " ", 
          RowBox[{"a1", "*", 
           RowBox[{"Map", "[", " ", 
            RowBox[{
             RowBox[{"Function", "[", 
              RowBox[{"vv", ",", " ", 
               RowBox[{
                RowBox[{"vv", "[", 
                 RowBox[{"[", "1", "]"}], "]"}], " ", 
                RowBox[{"th1", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"vv", "[", 
                    RowBox[{"[", "1", "]"}], "]"}], "-", "1"}], ")"}]}], " ", 
                RowBox[{"th2", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}], " ", 
                RowBox[{"w1", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "3", "]"}], "]"}]}], " ", 
                RowBox[{"w2", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "4", "]"}], "]"}]}]}]}], " ", "]"}], ",", "  ",
              "var1"}], " ", "]"}]}]}], " ", "]"}]}], " ", "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "a1", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", 
          "w2"}], "}"}], ",", " ", 
        RowBox[{"Apply", "[", " ", 
         RowBox[{"Plus", ",", " ", 
          RowBox[{"a1", "*", 
           RowBox[{"Map", "[", " ", 
            RowBox[{
             RowBox[{"Function", "[", 
              RowBox[{"vv", ",", " ", 
               RowBox[{
                RowBox[{"th1", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], " ", 
                RowBox[{"vv", "[", 
                 RowBox[{"[", "2", "]"}], "]"}], 
                RowBox[{"th2", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"vv", "[", 
                    RowBox[{"[", "2", "]"}], "]"}], "-", "1"}], ")"}]}], " ", 
                RowBox[{"w1", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "3", "]"}], "]"}]}], " ", 
                RowBox[{"w2", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "4", "]"}], "]"}]}]}]}], " ", "]"}], ",", "  ",
              "var1"}], "]"}]}]}], " ", "]"}]}], " ", "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "a1", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", 
          "w2"}], "}"}], ",", " ", 
        RowBox[{"Apply", "[", " ", 
         RowBox[{"Plus", ",", " ", 
          RowBox[{"a1", "*", 
           RowBox[{"Map", "[", " ", 
            RowBox[{
             RowBox[{"Function", "[", 
              RowBox[{"vv", ",", " ", 
               RowBox[{
                RowBox[{"th1", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], " ", 
                RowBox[{"th2", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}], " ", 
                RowBox[{"vv", "[", 
                 RowBox[{"[", "3", "]"}], "]"}], 
                RowBox[{"w1", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"vv", "[", 
                    RowBox[{"[", "3", "]"}], "]"}], "-", "1"}], ")"}]}], " ", 
                RowBox[{"w2", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "4", "]"}], "]"}]}]}]}], " ", "]"}], ",", "  ",
              "var1"}], " ", "]"}]}]}], " ", "]"}]}], " ", "]"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"Function", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
         "a1", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", 
          "w2"}], "}"}], ",", " ", 
        RowBox[{"Apply", "[", " ", 
         RowBox[{"Plus", ",", " ", 
          RowBox[{"a1", "*", 
           RowBox[{"Map", "[", " ", 
            RowBox[{
             RowBox[{"Function", "[", 
              RowBox[{"vv", ",", " ", 
               RowBox[{
                RowBox[{"th1", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], " ", 
                RowBox[{"th2", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}], " ", 
                RowBox[{"w1", "^", 
                 RowBox[{"vv", "[", 
                  RowBox[{"[", "3", "]"}], "]"}]}], " ", 
                RowBox[{"vv", "[", 
                 RowBox[{"[", "4", "]"}], "]"}], 
                RowBox[{"w2", "^", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"vv", "[", 
                    RowBox[{"[", "4", "]"}], "]"}], "-", "1"}], ")"}]}]}]}], 
              " ", "]"}], ",", "  ", "var1"}], " ", "]"}]}]}], " ", "]"}]}], 
       " ", "]"}]}], "\[IndentingNewLine]", "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MakeEulerComponents", "[", 
    RowBox[{
    "a_", ",", " ", "fns_", ",", " ", "times_", ",", " ", "th1_", ",", " ", 
     "th2_", ",", " ", "w1_", ",", " ", "w2_"}], "]"}], ":=", 
   RowBox[{"{", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{
      RowBox[{"(", 
       RowBox[{"fns", "[", 
        RowBox[{"[", "1", "]"}], "]"}], ")"}], "[", 
      RowBox[{"a", ",", " ", 
       RowBox[{
        RowBox[{"Transpose", "[", "th1", "]"}], "[", 
        RowBox[{"[", "2", "]"}], "]"}], ",", " ", 
       RowBox[{
        RowBox[{"Transpose", "[", "th2", "]"}], "[", 
        RowBox[{"[", "2", "]"}], "]"}], ",", " ", "w1", ",", "w2"}], "]"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"fns", "[", 
        RowBox[{"[", "2", "]"}], "]"}], ")"}], "[", 
      RowBox[{"a", ",", " ", 
       RowBox[{
        RowBox[{"Transpose", "[", "th1", "]"}], "[", 
        RowBox[{"[", "2", "]"}], "]"}], ",", " ", 
       RowBox[{
        RowBox[{"Transpose", "[", "th2", "]"}], "[", 
        RowBox[{"[", "2", "]"}], "]"}], ",", " ", "w1", ",", "w2"}], "]"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Interpolation", "[", " ", 
         RowBox[{"Transpose", "[", " ", 
          RowBox[{"{", 
           RowBox[{"times", ",", " ", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"fns", "[", 
               RowBox[{"[", "3", "]"}], "]"}], ")"}], "[", 
             RowBox[{"a", ",", " ", 
              RowBox[{
               RowBox[{"Transpose", "[", "th1", "]"}], "[", 
               RowBox[{"[", "2", "]"}], "]"}], ",", " ", 
              RowBox[{
               RowBox[{"Transpose", "[", "th2", "]"}], "[", 
               RowBox[{"[", "2", "]"}], "]"}], ",", " ", "w1", ",", "w2"}], 
             "]"}]}], "}"}], "]"}], "]"}], ")"}], "'"}], "[", "times", "]"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Interpolation", "[", " ", 
         RowBox[{"Transpose", "[", " ", 
          RowBox[{"{", 
           RowBox[{"times", ",", " ", 
            RowBox[{
             RowBox[{"(", 
              RowBox[{"fns", "[", 
               RowBox[{"[", "4", "]"}], "]"}], ")"}], "[", 
             RowBox[{"a", ",", " ", 
              RowBox[{
               RowBox[{"Transpose", "[", "th1", "]"}], "[", 
               RowBox[{"[", "2", "]"}], "]"}], ",", " ", 
              RowBox[{
               RowBox[{"Transpose", "[", "th2", "]"}], "[", 
               RowBox[{"[", "2", "]"}], "]"}], ",", " ", "w1", ",", "w2"}], 
             "]"}]}], "}"}], "]"}], "]"}], ")"}], "'"}], "[", "times", 
      "]"}]}], "\[IndentingNewLine]", "}"}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.663498245665387*^9, 3.6634982746589785`*^9}, {
   3.6634983355742517`*^9, 3.663498337843864*^9}, 3.6634984212621307`*^9, {
   3.6634984876112647`*^9, 3.6634988107775497`*^9}, {3.663498896628524*^9, 
   3.6634990338680153`*^9}, {3.6634991045522285`*^9, 3.66349914928901*^9}, {
   3.6634992269852333`*^9, 3.6634992605130386`*^9}, {3.6634993225290785`*^9, 
   3.663499334088296*^9}, {3.663499370690292*^9, 3.663499534889967*^9}, {
   3.6634996188205595`*^9, 3.663499651340663*^9}, {3.6635000791686172`*^9, 
   3.663500103790079*^9}, 3.6635001655709963`*^9, {3.663506948136937*^9, 
   3.663506971865305*^9}, {3.6635070186094985`*^9, 3.6635070282863607`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"MakeELScore", "[", "derivs_", "]"}], ":=", "\[IndentingNewLine]", 
   RowBox[{"Apply", "[", 
    RowBox[{"Plus", ",", " ", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"derivs", "[", 
         RowBox[{"[", "1", "]"}], "]"}], "+", 
        RowBox[{"derivs", "[", 
         RowBox[{"[", "2", "]"}], "]"}], "-", 
        RowBox[{"derivs", "[", 
         RowBox[{"[", "3", "]"}], "]"}], "-", 
        RowBox[{"derivs", "[", 
         RowBox[{"[", "4", "]"}], "]"}]}], ")"}], "^", "2"}]}], "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MakeNormScore", "[", "derivs_", "]"}], ":=", 
   "\[IndentingNewLine]", " ", 
   RowBox[{"Apply", "[", 
    RowBox[{"Plus", ",", " ", 
     RowBox[{
      RowBox[{
       RowBox[{"derivs", "[", 
        RowBox[{"[", "1", "]"}], "]"}], "^", "2"}], " ", "+", " ", 
      RowBox[{
       RowBox[{"derivs", "[", 
        RowBox[{"[", "2", "]"}], "]"}], "^", "2"}], " ", "+", " ", 
      RowBox[{
       RowBox[{"derivs", "[", 
        RowBox[{"[", "3", "]"}], "]"}], "^", "2"}], " ", "+", " ", 
      RowBox[{
       RowBox[{"derivs", "[", 
        RowBox[{"[", "4", "]"}], "]"}], "^", "2"}]}]}], "]"}]}], 
  ";"}]}], "Input",
 CellChangeTimes->{{3.663499669660698*^9, 3.6634997612957745`*^9}, {
  3.6635076627130485`*^9, 3.663507698984815*^9}, {3.6635078168485737`*^9, 
  3.663507897816082*^9}, {3.6635079487722645`*^9, 3.66350795137611*^9}}],

Cell["\<\
To demonstrate these functions, firstly build the list of partial derivative \
functions. See that each monomial as to be in the form of a sublist\
\>", "Text",
 CellChangeTimes->{{3.6634997858702307`*^9, 3.6634998182682467`*^9}, {
  3.6635061816784215`*^9, 3.663506194209326*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"fff", " ", "=", " ", 
   RowBox[{"MakePartialDerivativesFns", "[", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
      RowBox[{"{", 
       RowBox[{"2", ",", "2", ",", "2", ",", "2"}], "}"}]}], "}"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.663499821407508*^9, 3.6634998372046986`*^9}, 
   3.663499967479245*^9, {3.663506121150454*^9, 3.663506131944109*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{
  RowBox[{"(", 
   RowBox[{"fff", "[", 
    RowBox[{"[", "1", "]"}], "]"}], ")"}], "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"1", ",", "1"}], "}"}], ",", " ", "1", ",", "1", ",", "2", ",", 
   "2"}], "]"}]], "Input",
 CellChangeTimes->{{3.663500125611611*^9, 3.663500137298912*^9}, {
  3.663500201415433*^9, 3.6635002025242186`*^9}, {3.6635061674893427`*^9, 
  3.6635061712480135`*^9}}],

Cell[BoxData["36"], "Output",
 CellChangeTimes->{
  3.6635001379693584`*^9, {3.6635001832615347`*^9, 3.6635002035539503`*^9}, 
   3.6635060402859783`*^9, 3.663506139072157*^9, 3.6635061719395056`*^9, 
   3.663506203454893*^9}]
}, Open  ]],

Cell["\<\
MakeEulerComponents  provides 4 sublists; the first 2 are the partials dL/dq \
and the 2nd 2 are d/dt(dL/dw) ; sorry cant do a partial sign on this. So for \
this polynomial structure
we can just make out choice of coefficients a.\
\>", "Text",
 CellChangeTimes->{{3.663506324895195*^9, 3.663506330855397*^9}, {
  3.663506406025797*^9, 3.663506502364238*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"ELComponentsData", "=", 
   RowBox[{"MakeEulerComponents", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"3", ",", "2"}], "}"}], ",", " ", "fff", ",", " ", "times", ",",
      " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", "w2"}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6634998861624775`*^9, 3.6634999195351863`*^9}, {
   3.6634999623616104`*^9, 3.663499970925703*^9}, 3.6635000071424203`*^9, {
   3.6635062180002337`*^9, 3.663506233059923*^9}, {3.6635062684310513`*^9, 
   3.6635062731934414`*^9}, {3.6635064615252256`*^9, 3.663506479378914*^9}, {
   3.663506535482762*^9, 3.663506541294891*^9}, {3.663507418353476*^9, 
   3.6635074218039074`*^9}}],

Cell[TextData[{
 "This is how ",
 StyleBox["Mathematica",
  FontSlant->"Italic"],
 " does standard form"
}], "Text",
 CellChangeTimes->{{3.6635074033988614`*^9, 3.6635074115106077`*^9}}],

Cell[CellGroupData[{

Cell[BoxData["3.3*^-4"], "Input",
 CellChangeTimes->{{3.6635070546170616`*^9, 3.66350714607303*^9}, {
  3.6635072089557037`*^9, 3.663507210796013*^9}}],

Cell[BoxData["0.00033`"], "Output",
 CellChangeTimes->{{3.6635070755929785`*^9, 3.6635071465863967`*^9}, 
   3.6635072116496153`*^9}]
}, Open  ]],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.663507218162244*^9, 3.6635072245958166`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"ELComponentsControl", " ", "=", " ", 
    RowBox[{"MakeEulerComponents", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"3", ",", "2"}], "}"}], ",", " ", "fff", ",", " ", "times", 
      ",", " ", "controlth1", ",", " ", "controlth2", ",", " ", "controlw1", 
      ",", " ", "controlw2"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{{3.6635065461553507`*^9, 3.663506606880499*^9}, 
   3.6635066893670874`*^9, {3.663506911436837*^9, 3.663506914645116*^9}, 
   3.6635074254785204`*^9}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"ELDataScore", " ", "=", " ", 
  RowBox[{"MakeELScore", "[", "ELComponentsData", "]"}]}]], "Input",
 CellChangeTimes->{{3.663507611077366*^9, 3.663507625356517*^9}, {
  3.663507716523303*^9, 3.6635077212926636`*^9}, {3.6635077870293765`*^9, 
  3.663507794084374*^9}}],

Cell[BoxData["38963.712211428625`"], "Output",
 CellChangeTimes->{
  3.6635076257918353`*^9, {3.663507670762782*^9, 3.6635077226566477`*^9}, 
   3.663507796233901*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"ELControlScore", " ", "=", " ", 
  RowBox[{"MakeELScore", "[", "ELComponentsControl", "]"}]}]], "Input",
 CellChangeTimes->{{3.6635077297406626`*^9, 3.66350774598921*^9}, {
  3.66350780020575*^9, 3.6635078038813343`*^9}}],

Cell[BoxData["0.12779616359302567`"], "Output",
 CellChangeTimes->{3.663507746818797*^9, 3.663507804782975*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"NormDataScore", " ", "=", " ", 
  RowBox[{"MakeNormScore", "[", "ELComponentsData", "]"}]}]], "Input",
 CellChangeTimes->{{3.663507909399295*^9, 3.6635079190991893`*^9}, {
  3.663507961730483*^9, 3.6635079739141226`*^9}}],

Cell[BoxData["131186.4800501223`"], "Output",
 CellChangeTimes->{
  3.663507919964795*^9, {3.6635079638599806`*^9, 3.663507974614621*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"NormControlScore", " ", "=", " ", 
  RowBox[{"MakeNormScore", "[", "ELComponentsControl", "]"}]}]], "Input",
 CellChangeTimes->{{3.663507977382593*^9, 3.663508000734177*^9}}],

Cell[BoxData["0.3134529105046617`"], "Output",
 CellChangeTimes->{3.663508001743894*^9}]
}, Open  ]],

Cell["\<\
Now construct the final score
\
\>", "Text",
 CellChangeTimes->{{3.6635080151464415`*^9, 3.663508023562408*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"U", "[", "x_", "]"}], ":=", 
   RowBox[{"N", "[", 
    RowBox[{"1", "+", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"Log", "[", 
        RowBox[{"x", "+", "1*^-15"}], "]"}], "^", "2"}], ")"}]}], "]"}]}], 
  ";"}]], "Input",
 CellChangeTimes->{{3.6635080281506715`*^9, 3.6635080910723505`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"U", "[", "2", "]"}]], "Input",
 CellChangeTimes->{{3.6635080798293657`*^9, 3.6635080815405793`*^9}}],

Cell[BoxData["1.480453013918202`"], "Output",
 CellChangeTimes->{{3.663508082044939*^9, 3.6635080935381174`*^9}}]
}, Open  ]],

Cell["This is the final score", "Text",
 CellChangeTimes->{{3.663508172708351*^9, 3.663508185819659*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Log", "[", 
  RowBox[{
   RowBox[{"U", "[", "NormDataScore", "]"}], " ", 
   RowBox[{"U", "[", "ELControlScore", "]"}], "*", 
   RowBox[{"ELDataScore", "/", "ELControlScore"}]}], "]"}]], "Input",
 CellChangeTimes->{{3.6635081057928066`*^9, 3.6635081612872467`*^9}}],

Cell[BoxData["19.223329642367908`"], "Output",
 CellChangeTimes->{{3.6635081509308743`*^9, 3.663508161763568*^9}}]
}, Open  ]],

Cell["Wrapping this into a function", "Text",
 CellChangeTimes->{{3.6635082029008226`*^9, 3.663508207548094*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"FinalScore", "[", 
   RowBox[{"data_", ",", " ", "control_"}], "]"}], ":=", 
  RowBox[{"Module", "[", " ", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"x1", ",", " ", "x2", ",", " ", "x3"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"x1", " ", "=", " ", 
      RowBox[{"MakeELScore", "[", "data", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"x2", " ", "=", " ", 
      RowBox[{"MakeELScore", "[", "control", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"x3", " ", "=", " ", 
      RowBox[{"MakeNormScore", "[", "data", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"Log", "[", 
      RowBox[{
       RowBox[{"U", "[", "x3", "]"}], " ", 
       RowBox[{"U", "[", "x2", "]"}], " ", 
       RowBox[{"x1", "/", "x2"}]}], "]"}]}]}], "\[IndentingNewLine]", 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.6635082157058883`*^9, 3.663508466441039*^9}, 
   3.6635084985368133`*^9}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"FinalScore", "[", 
  RowBox[{"ELComponentsData", ",", " ", "ELComponentsControl"}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.6635085071189227`*^9, 3.66350853332152*^9}}],

Cell[BoxData["19.223329642367908`"], "Output",
 CellChangeTimes->{3.6635085340450363`*^9}]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"FinalScoreWithCoeff", "[", 
   RowBox[{
   "a_", ",", " ", "fff_", ",", " ", "times_", ",", " ", "th1_", ",", " ", 
    "th2_", ",", " ", "w1_", ",", " ", "w2_", ",", " ", "controlth1_", ",", 
    " ", "controlth2_", ",", " ", "controlw1_", ",", " ", "controlw2_"}], 
   "]"}], ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"data", ",", " ", "control"}], "}"}], ",", "\[IndentingNewLine]",
     "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"data", " ", "=", " ", 
      RowBox[{"MakeEulerComponents", "[", 
       RowBox[{
       "a", ",", " ", "fff", ",", " ", "times", ",", " ", "th1", ",", " ", 
        "th2", ",", " ", "w1", ",", " ", "w2"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"control", " ", "=", " ", 
      RowBox[{"MakeEulerComponents", "[", 
       RowBox[{
       "a", ",", " ", "fff", ",", " ", "times", ",", " ", "controlth1", ",", 
        " ", "controlth2", ",", " ", "controlw1", ",", " ", "controlw2"}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"FinalScore", "[", 
      RowBox[{"data", ",", " ", "control"}], "]"}]}]}], "\[IndentingNewLine]",
    "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.6635086290705585`*^9, 3.66350866584368*^9}, {
  3.663508711687229*^9, 3.6635088883277297`*^9}}],

Cell["\<\
FinalScoreWithCoeff takes a list of coefficients in this case it is {3,2} and \
then used the existing list of functions and the data to find the score. So \
this is what we want to use to minimise\
\>", "Text",
 CellChangeTimes->{{3.6635090179307833`*^9, 3.6635090917342143`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"FinalScoreWithCoeff", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{"3", ",", "2"}], "}"}], ",", " ", "fff", ",", " ", "times", ",", 
   " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", "w2", ",", " ", 
   "controlth1", ",", "controlth2", ",", " ", "controlw1", ",", " ", 
   "controlw2"}], "]"}]], "Input",
 CellChangeTimes->{{3.663508897588321*^9, 3.66350893492782*^9}, {
  3.6635089876152487`*^9, 3.663509008426037*^9}}],

Cell[BoxData["19.223329642367908`"], "Output",
 CellChangeTimes->{
  3.6635089355842857`*^9, {3.663508993086149*^9, 3.6635090096278834`*^9}}]
}, Open  ]],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.663509345578557*^9, 3.6635093800390215`*^9}}],

Cell["\<\
Have to play with some local variables in order to make NMinimize work, I \
think that I will have to construct the parameters list; This is how you use \
NMinimize

\
\>", "Text",
 CellChangeTimes->{{3.663509246117901*^9, 3.663509262060213*^9}, {
  3.663510837452362*^9, 3.6635109223486633`*^9}, {3.6635111850052824`*^9, 
  3.663511198124572*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"hhh", "[", "x_", "]"}], ":=", 
  RowBox[{"x", "^", "2"}]}]], "Input",
 CellChangeTimes->{{3.6635109384351077`*^9, 3.6635109435577383`*^9}}],

Cell[BoxData[
 RowBox[{"NMinimize", "[", 
  RowBox[{
   RowBox[{"hhh", "[", "x", "]"}], ",", " ", "x"}], "]"}]], "Input",
 CellChangeTimes->{{3.6635109454510746`*^9, 3.663510952575137*^9}, {
  3.6635111632978344`*^9, 3.6635111640353565`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"{", 
   RowBox[{"0.`", ",", 
    RowBox[{"{", 
     RowBox[{"x", "\[Rule]", "0.`"}], "}"}]}], "}"}], "\[IndentingNewLine]"}]],\
 "Input",
 CellChangeTimes->{{3.6635112065445538`*^9, 3.6635113501425676`*^9}, 
   3.6635113836954055`*^9}],

Cell[BoxData[
 RowBox[{
  RowBox[{"NelderMeadIt", "[", 
   RowBox[{
   "fff", ",", " ", "times", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1",
     ",", " ", "w2", ",", " ", "controlth1", ",", " ", "controlth2", ",", " ",
     "controlw1", ",", " ", "controlw2"}], "]"}], ":=", 
  RowBox[{"{", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"InnerNM", "[", 
      RowBox[{"a1_", ",", " ", "a2_"}], "]"}], ":=", " ", 
     RowBox[{"FinalScoreWithCoeff", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"a1", ",", "a2"}], "}"}], ",", " ", "fff", ",", " ", "times", 
       ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", "w2", ",", 
       " ", "controlth1", ",", " ", "controlth2", ",", " ", "controlw1", ",", 
       " ", "controlw2"}], "]"}]}], ";", "\[IndentingNewLine]", 
    RowBox[{"NMinimize", "[", 
     RowBox[{
      RowBox[{"InnerNM", "[", 
       RowBox[{"a1", ",", "a2"}], "]"}], ",", " ", 
      RowBox[{"{", 
       RowBox[{"a1", ",", "a2"}], "}"}], ",", " ", 
      RowBox[{"Method", "\[Rule]", "\"\<NelderMead\>\""}]}], "]"}]}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "}"}]}]], "Input"],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"NelderMeadIt", "[", 
  RowBox[{
  "fff", ",", " ", "times", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", 
   ",", " ", "w2", ",", " ", "controlth1", ",", " ", "controlth2", ",", " ", 
   "controlw1", ",", " ", "controlw2"}], "]"}]], "Input",
 CellChangeTimes->{{3.663511393084074*^9, 3.6635113944170184`*^9}, {
  3.6635129827470407`*^9, 3.6635130086534357`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"{", 
   RowBox[{"16.160591671821233`", ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"a1", "\[Rule]", "8.187371350453308`"}], ",", 
      RowBox[{"a2", "\[Rule]", "1.4003649034523291`"}]}], "}"}]}], "}"}], 
  "}"}]], "Output",
 CellChangeTimes->{3.663513034925104*^9, 3.6635132915483093`*^9}]
}, Open  ]],

Cell["\<\
This is quite slow - it took about 20 sec, So it would take about  30 min per \
population\
\>", "Text",
 CellChangeTimes->{{3.663513351467876*^9, 3.663513395413624*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"symbolAppend", "[", 
    RowBox[{"symbol_", ",", "postfix_"}], "]"}], ":=", 
   RowBox[{"Symbol", "[", 
    RowBox[{
     RowBox[{"SymbolName", "[", "symbol", "]"}], "<>", 
     RowBox[{"ToString", "[", "postfix", "]"}]}], "]"}]}], 
  "\[IndentingNewLine]"}]], "Input",
 CellChangeTimes->{
  3.6635242525260134`*^9, {3.663524981350789*^9, 3.663524999610763*^9}, {
   3.6635250397983165`*^9, 3.663525059851556*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"Map", "[", " ", 
  RowBox[{
   RowBox[{
    RowBox[{"symbolAppend", "[", 
     RowBox[{"v", ",", " ", "#"}], "]"}], "&"}], ",", " ", 
   RowBox[{"Table", "[", 
    RowBox[{"i", ",", " ", 
     RowBox[{"{", 
      RowBox[{"i", ",", " ", "1", ",", " ", "10"}], "}"}]}], "]"}]}], 
  "]"}]], "Input",
 CellChangeTimes->{{3.6635242662607703`*^9, 3.6635244398801274`*^9}, {
  3.6635250113281145`*^9, 3.6635250251749516`*^9}, {3.663525070164889*^9, 
  3.6635251036646805`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "v1", ",", "v2", ",", "v3", ",", "v4", ",", "v5", ",", "v6", ",", "v7", ",",
    "v8", ",", "v9", ",", "v10"}], "}"}]], "Output",
 CellChangeTimes->{3.663525104405205*^9}]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"MakeSymbols", "[", "num_", "]"}], ":=", 
  RowBox[{"Map", "[", 
   RowBox[{
    RowBox[{
     RowBox[{"symbolAppend", "[", 
      RowBox[{"v", ",", " ", "#"}], "]"}], "&"}], ",", " ", 
    RowBox[{"Table", "[", 
     RowBox[{"i", ",", " ", 
      RowBox[{"{", 
       RowBox[{"i", ",", "1", ",", "num"}], "}"}]}], "]"}]}], 
   "]"}]}]], "Input",
 CellChangeTimes->{{3.66352515722625*^9, 3.6635252016297865`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"MakeSymbols", "[", "10", "]"}]], "Input",
 CellChangeTimes->{{3.663525208761861*^9, 3.6635252147871633`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
  "v1", ",", "v2", ",", "v3", ",", "v4", ",", "v5", ",", "v6", ",", "v7", ",",
    "v8", ",", "v9", ",", "v10"}], "}"}]], "Output",
 CellChangeTimes->{3.6635252158819113`*^9}]
}, Open  ]],

Cell["\<\
Another attempt at NM this time without hardcoding the number of monomials\
\>", "Text",
 CellChangeTimes->{{3.6635252436564455`*^9, 3.6635252692456155`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"NelderMeadIt2", "[", 
   RowBox[{
   "numCoefficients_", ",", " ", "fff_", ",", " ", "times_", ",", " ", "th1_",
     ",", " ", "th2_", ",", " ", "w1_", ",", " ", "w2_", ",", " ", 
    "controlth1_", ",", " ", "controlth2_", ",", " ", "controlw1_", ",", " ", 
    "controlw2_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"a", ",", " ", "cmd", ",", " ", "res"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"a", " ", "=", " ", 
      RowBox[{"MakeSymbols", "[", "numCoefficients", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"InnerNM", "=", 
      RowBox[{"Function", "[", 
       RowBox[{"a", ",", " ", 
        RowBox[{"FinalScoreWithCoeff", "[", 
         RowBox[{
         "a", ",", " ", "fff", ",", " ", "times", ",", " ", "th1", ",", " ", 
          "th2", ",", " ", "w1", ",", " ", "w2", ",", " ", "controlth1", ",", 
          " ", "controlth2", ",", " ", "controlw1", ",", " ", "controlw2"}], 
         "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", " ", 
     RowBox[{"cmd", " ", "=", " ", 
      RowBox[{"StringJoin", "[", 
       RowBox[{"\"\<NMinimize[InnerNM[\>\"", ",", " ", 
        RowBox[{"ToString", "[", "a", "]"}], ",", " ", "\"\<],\>\"", ",", " ", 
        RowBox[{"ToString", "[", "a", "]"}], ",", " ", 
        "\"\<, Method->\\\"NelderMead\\\"]\>\""}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"res", " ", "=", " ", 
      RowBox[{"Evaluate", "[", 
       RowBox[{"ToExpression", "[", "cmd", "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"res", "[", 
         RowBox[{"[", "1", "]"}], "]"}], ",", "a"}], "}"}], " ", "/.", 
      RowBox[{"res", "[", 
       RowBox[{"[", "2", "]"}], "]"}]}]}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", "\[IndentingNewLine]", "\[IndentingNewLine]", 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.6635252790605893`*^9, 3.6635253579256144`*^9}, {
  3.663525411165451*^9, 3.663525429206259*^9}, {3.663525494975972*^9, 
  3.66352553618826*^9}, {3.6635257742211833`*^9, 3.6635257773714447`*^9}, {
  3.6635258462533484`*^9, 3.663525877751754*^9}, {3.663525972704312*^9, 
  3.66352606762263*^9}, {3.6635261590988626`*^9, 3.663526162534303*^9}, {
  3.663526251592571*^9, 3.6635263842568145`*^9}, {3.6635264152588625`*^9, 
  3.663526419042533*^9}, {3.6635264520710278`*^9, 3.663526494069901*^9}, {
  3.6635265734573927`*^9, 3.6635266178979435`*^9}}],

Cell["\<\
Try to put it all together; we are given data times, th1, th2 etc and a poly \
representation and we have to find the best coefficients and the score\
\>", "Text",
 CellChangeTimes->{{3.6635267674917517`*^9, 3.6635268216872396`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{"NelderMeadIt3", "[", 
   RowBox[{
   "var_", ",", " ", "times_", ",", " ", "th1_", ",", " ", "th2_", ",", " ", 
    "w1_", ",", " ", "w2_", ",", " ", "controlth1_", ",", " ", "controlth2_", 
    ",", " ", "controlw1_", ",", " ", "controlw2_"}], "]"}], ":=", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "fff", ",", "numCoefficients", ",", "a", ",", " ", "cmd", ",", " ", 
      "res"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"fff", " ", "=", " ", 
      RowBox[{"MakePartialDerivativesFns", "[", "var", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"numCoefficients", "=", 
      RowBox[{"Length", "[", "var", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"a", " ", "=", " ", 
      RowBox[{"MakeSymbols", "[", "numCoefficients", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"InnerNM", "=", 
      RowBox[{"Function", "[", 
       RowBox[{"a", ",", " ", 
        RowBox[{"FinalScoreWithCoeff", "[", 
         RowBox[{
         "a", ",", " ", "fff", ",", " ", "times", ",", " ", "th1", ",", " ", 
          "th2", ",", " ", "w1", ",", " ", "w2", ",", " ", "controlth1", ",", 
          " ", "controlth2", ",", " ", "controlw1", ",", " ", "controlw2"}], 
         "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", " ", 
     RowBox[{"cmd", " ", "=", " ", 
      RowBox[{"StringJoin", "[", 
       RowBox[{"\"\<NMinimize[InnerNM[\>\"", ",", " ", 
        RowBox[{"ToString", "[", "a", "]"}], ",", " ", "\"\<],\>\"", ",", " ", 
        RowBox[{"ToString", "[", "a", "]"}], ",", " ", 
        "\"\<, Method->\\\"NelderMead\\\"]\>\""}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"res", " ", "=", " ", 
      RowBox[{"Evaluate", "[", 
       RowBox[{"ToExpression", "[", "cmd", "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"res", "[", 
         RowBox[{"[", "1", "]"}], "]"}], ",", "a"}], "}"}], " ", "/.", 
      RowBox[{"res", "[", 
       RowBox[{"[", "2", "]"}], "]"}]}]}]}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 CellChangeTimes->{{3.663526826276498*^9, 3.663526834334223*^9}, {
  3.663526923096301*^9, 3.66352711301622*^9}}],

Cell[CellGroupData[{

Cell["From Poly to Score", "Chapter",
 CellChangeTimes->{{3.6635272317537856`*^9, 3.6635272386946945`*^9}}],

Cell["\<\
You have to enter the polynomial with each monomial specified like \
{{1,1,1,1},{2,2,2,2},{1,2,0,0}} etc\
\>", "Text",
 CellChangeTimes->{{3.663527279065394*^9, 3.6635273204698086`*^9}}],

Cell[BoxData[""], "Text", "Input",
 CellChangeTimes->{{3.6635272502428956`*^9, 3.6635272662412634`*^9}}],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"NelderMeadIt3", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "2", ",", "2", ",", "2"}], "}"}]}], "}"}], ",", " ", 
   "times", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", "w2", 
   ",", " ", "controlth1", ",", " ", "controlth2", ",", " ", "controlw1", ",",
    " ", "controlw2"}], "]"}]], "Input",
 CellChangeTimes->{{3.6635271229593115`*^9, 3.663527167092635*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"16.160591671821233`", ",", 
   RowBox[{"{", 
    RowBox[{"8.187371350453308`", ",", "1.4003649034523291`"}], "}"}]}], 
  "}"}]], "Output",
 CellChangeTimes->{3.6635272060513506`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"NelderMeadIt3", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "2", ",", "0", ",", "0"}], "}"}]}], "}"}], ",", " ", 
   "times", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", "w2", 
   ",", " ", "controlth1", ",", " ", "controlth2", ",", " ", "controlw1", ",",
    " ", "controlw2"}], "]"}]], "Input",
 CellChangeTimes->{{3.6635273394142375`*^9, 3.6635273399806395`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{
   RowBox[{"-", "0.6542483978806023`"}], ",", 
   RowBox[{"{", 
    RowBox[{"0.013976610784683015`", ",", "0.07506933418371137`"}], "}"}]}], 
  "}"}]], "Output",
 CellChangeTimes->{3.6635273718203306`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell[BoxData[
 RowBox[{"NelderMeadIt3", "[", 
  RowBox[{
   RowBox[{"{", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"1", ",", "1", ",", "1", ",", "1"}], "}"}], ",", 
     RowBox[{"{", 
      RowBox[{"2", ",", "2", ",", "2", ",", "2"}], "}"}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"2", ",", "1", ",", "2", ",", "1"}], "}"}]}], "}"}], ",", " ", 
   "times", ",", " ", "th1", ",", " ", "th2", ",", " ", "w1", ",", " ", "w2", 
   ",", " ", "controlth1", ",", " ", "controlth2", ",", " ", "controlw1", ",",
    " ", "controlw2"}], "]"}]], "Input",
 CellChangeTimes->{{3.663527385573702*^9, 3.6635273977710342`*^9}}],

Cell[BoxData[
 RowBox[{"{", 
  RowBox[{"16.1461817981514`", ",", 
   RowBox[{"{", 
    RowBox[{
    "8.104269994993064`", ",", "1.3667574371507603`", ",", 
     "0.3696613993205021`"}], "}"}]}], "}"}]], "Output",
 CellChangeTimes->{3.6635274168345556`*^9}]
}, Open  ]],

Cell["\<\
Each run of NelderMeadIt3 takes 30 sec to complete - not good, very not good\
\>", "Subchapter",
 CellChangeTimes->{{3.663527438228755*^9, 3.663527461869569*^9}}]
}, Open  ]]
}, Open  ]]
},
WindowToolbars->"EditBar",
WindowSize->{1350, 669},
WindowMargins->{{0, Automatic}, {Automatic, 0}},
FrontEndVersion->"10.0 for Microsoft Windows (64-bit) (December 4, 2014)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 101, 1, 101, "Title"],
Cell[684, 25, 231, 3, 30, "Text"],
Cell[918, 30, 412, 11, 31, "Input"],
Cell[1333, 43, 282, 7, 31, "Input"],
Cell[1618, 52, 165, 4, 31, "Input"],
Cell[1786, 58, 98, 1, 30, "Text"],
Cell[1887, 61, 410, 12, 31, "Input"],
Cell[2300, 75, 393, 11, 31, "Input"],
Cell[2696, 88, 395, 11, 31, "Input"],
Cell[3094, 101, 204, 4, 30, "Text"],
Cell[3301, 107, 304, 9, 31, "Input"],
Cell[3608, 118, 304, 9, 31, "Input"],
Cell[3915, 129, 592, 11, 87, "Text"],
Cell[4510, 142, 1040, 29, 31, "Input"],
Cell[5553, 173, 212, 4, 30, "Text"],
Cell[5768, 179, 414, 12, 31, "Input"],
Cell[CellGroupData[{
Cell[6207, 195, 239, 6, 31, "Input"],
Cell[6449, 203, 99, 1, 31, "Output"]
}, Open  ]],
Cell[6563, 207, 379, 6, 49, "Text"],
Cell[6945, 215, 1320, 35, 31, "Input"],
Cell[8268, 252, 1266, 34, 31, "Input"],
Cell[9537, 288, 1263, 34, 31, "Input"],
Cell[10803, 324, 1270, 35, 31, "Input"],
Cell[12076, 361, 105, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[12206, 366, 328, 8, 31, "Input"],
Cell[12537, 376, 279, 7, 31, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[12853, 388, 164, 3, 31, "Input"],
Cell[13020, 393, 1403, 40, 33, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[14460, 438, 169, 3, 31, "Input"],
Cell[14632, 443, 1372, 39, 33, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[16041, 487, 166, 3, 31, "Input"],
Cell[16210, 492, 1373, 39, 33, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[17620, 536, 220, 4, 31, "Input"],
Cell[17843, 542, 1373, 39, 33, "Output"]
}, Open  ]],
Cell[19231, 584, 109, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[19365, 589, 277, 6, 31, "Input"],
Cell[19645, 597, 191, 4, 31, "Output"]
}, Open  ]],
Cell[19851, 604, 235, 5, 30, "Text"],
Cell[20089, 611, 637, 15, 31, "Input"],
Cell[20729, 628, 507, 13, 31, "Input"],
Cell[21239, 643, 507, 13, 31, "Input"],
Cell[21749, 658, 528, 13, 31, "Input"],
Cell[22280, 673, 246, 4, 30, "Text"],
Cell[22529, 679, 157, 3, 30, "Text"],
Cell[22689, 684, 427, 12, 31, "Input"],
Cell[23119, 698, 423, 12, 31, "Input"],
Cell[23545, 712, 178, 4, 30, "Text"],
Cell[23726, 718, 328, 7, 31, "Input"],
Cell[24057, 727, 122, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[24204, 732, 372, 7, 31, "Input"],
Cell[24579, 741, 218, 3, 31, "Output"]
}, Open  ]],
Cell[24812, 747, 132, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[24969, 752, 589, 12, 31, "Input"],
Cell[25561, 766, 178, 2, 31, "Output"]
}, Open  ]],
Cell[25754, 771, 126, 1, 30, "Text"],
Cell[25883, 774, 116, 1, 30, "Text"],
Cell[26002, 777, 152, 3, 31, "Input"],
Cell[26157, 782, 140, 1, 30, "Text"],
Cell[26300, 785, 591, 13, 31, "Input"],
Cell[26894, 800, 693, 15, 52, "Input"],
Cell[27590, 817, 232, 5, 30, "Text"],
Cell[27825, 824, 8804, 216, 272, "Input"],
Cell[36632, 1042, 1470, 40, 92, "Input"],
Cell[38105, 1084, 291, 5, 30, "Text"],
Cell[38399, 1091, 476, 12, 31, "Input"],
Cell[CellGroupData[{
Cell[38900, 1107, 414, 11, 31, "Input"],
Cell[39317, 1120, 226, 4, 31, "Output"]
}, Open  ]],
Cell[39558, 1127, 369, 7, 49, "Text"],
Cell[39930, 1136, 710, 14, 31, "Input"],
Cell[40643, 1152, 186, 6, 30, "Text"],
Cell[CellGroupData[{
Cell[40854, 1162, 151, 2, 31, "Input"],
Cell[41008, 1166, 133, 2, 31, "Output"]
}, Open  ]],
Cell[41156, 1171, 94, 1, 31, "Input"],
Cell[41253, 1174, 568, 13, 52, "Input"],
Cell[CellGroupData[{
Cell[41846, 1191, 290, 5, 31, "Input"],
Cell[42139, 1198, 167, 3, 31, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[42343, 1206, 245, 4, 31, "Input"],
Cell[42591, 1212, 111, 1, 31, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[42739, 1218, 245, 4, 31, "Input"],
Cell[42987, 1224, 138, 2, 31, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[43162, 1231, 198, 3, 31, "Input"],
Cell[43363, 1236, 88, 1, 31, "Output"]
}, Open  ]],
Cell[43466, 1240, 122, 4, 49, "Text"],
Cell[43591, 1246, 347, 11, 31, "Input"],
Cell[CellGroupData[{
Cell[43963, 1261, 124, 2, 31, "Input"],
Cell[44090, 1265, 113, 1, 31, "Output"]
}, Open  ]],
Cell[44218, 1269, 105, 1, 30, "Text"],
Cell[CellGroupData[{
Cell[44348, 1274, 289, 6, 31, "Input"],
Cell[44640, 1282, 114, 1, 31, "Output"]
}, Open  ]],
Cell[44769, 1286, 113, 1, 30, "Text"],
Cell[44885, 1289, 959, 25, 132, "Input"],
Cell[CellGroupData[{
Cell[45869, 1318, 194, 4, 31, "Input"],
Cell[46066, 1324, 90, 1, 31, "Output"]
}, Open  ]],
Cell[46171, 1328, 1340, 30, 152, "Input"],
Cell[47514, 1360, 291, 5, 30, "Text"],
Cell[CellGroupData[{
Cell[47830, 1369, 453, 9, 31, "Input"],
Cell[48286, 1380, 141, 2, 31, "Output"]
}, Open  ]],
Cell[48442, 1385, 94, 1, 31, "Input"],
Cell[48539, 1388, 358, 9, 68, "Text"],
Cell[48900, 1399, 174, 4, 31, "Input"],
Cell[49077, 1405, 242, 5, 31, "Input"],
Cell[49322, 1412, 270, 8, 52, InheritFromParent],
Cell[49595, 1422, 1204, 27, 152, "Input"],
Cell[CellGroupData[{
Cell[50824, 1453, 391, 7, 31, "Input"],
Cell[51218, 1462, 338, 9, 31, "Output"]
}, Open  ]],
Cell[51571, 1474, 180, 4, 30, "Text"],
Cell[51754, 1480, 461, 12, 52, "Input"],
Cell[CellGroupData[{
Cell[52240, 1496, 494, 13, 31, "Input"],
Cell[52737, 1511, 213, 5, 31, "Output"]
}, Open  ]],
Cell[52965, 1519, 447, 13, 31, "Input"],
Cell[CellGroupData[{
Cell[53437, 1536, 133, 2, 31, "Input"],
Cell[53573, 1540, 215, 5, 31, "Output"]
}, Open  ]],
Cell[53803, 1548, 168, 3, 30, "Text"],
Cell[53974, 1553, 2526, 53, 232, "Input"],
Cell[56503, 1608, 243, 4, 30, "Text"],
Cell[56749, 1614, 2256, 51, 212, "Input"],
Cell[CellGroupData[{
Cell[59030, 1669, 107, 1, 72, "Chapter"],
Cell[59140, 1672, 196, 4, 30, "Text"],
Cell[59339, 1678, 104, 1, 31, "Text"],
Cell[CellGroupData[{
Cell[59468, 1683, 533, 12, 31, "Input"],
Cell[60004, 1697, 222, 6, 31, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[60263, 1708, 535, 12, 31, "Input"],
Cell[60801, 1722, 245, 7, 31, "Output"]
}, Open  ]],
Cell[CellGroupData[{
Cell[61083, 1734, 621, 14, 31, "Input"],
Cell[61707, 1750, 256, 7, 31, "Output"]
}, Open  ]],
Cell[61978, 1760, 172, 3, 67, "Subchapter"]
}, Open  ]]
}, Open  ]]
}
]
*)

(* End of internal cache information *)
